apiVersion: apps/v1
kind: Deployment
metadata:
  name: openrelik-server
  namespace: openrelik
  labels:
    app: server
spec:
  replicas: {{ .Values.openrelik.server.replicas }}
  selector:
    matchLabels:
      app: server
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: server
    spec:
      serviceAccountName: openrelik-sa
      initContainers:
        - name: create-dirs
          image: busybox:1.37
          command: ['sh', '-c', "mkdir -p /usr/share/openrelik/data/artifacts; mkdir -p /usr/share/openrelik/config"]
          volumeMounts:
          - name: vol-data
            mountPath: /usr/share/openrelik
      {{- if .Values.postgres.managedSecret }}
        - name: init-server
          image: busybox:1.37.0
          command: ["/bin/sh", "-c"]
          args: ["export DB_PWD=$(cat /var/secrets/password.txt); cp /etc/openrelik/settings.toml /var/config/settings.toml; sed -i \"s/<REPLACE_WITH_POSTGRES_PASSWORD>/$DB_PWD/g\" /var/config/settings.toml"]
          volumeMounts:
          - name: vol-openrelik-db-sec
            mountPath: /var/secrets
          - name: vol-settings
            mountPath: /etc/openrelik/settings.toml
            subPath: settings.toml
          - name: vol-config
            mountPath: /var/config
      {{- end }}
      containers:
        - name: openrelik-server
          image: {{ .Values.openrelik.server.image }}
          {{- if .Values.global.useResourceRequests }}
          resources:
            requests:
              memory: "2Gi"
              cpu: "1000m"
          {{- end }}
          args:
            - uvicorn
            - main:app
            - --proxy-headers
            - --forwarded-allow-ips
            - '*'
            - --workers
            - "1"
            - --host
            - 0.0.0.0
            - --port
            - "{{ .Values.openrelik.server.port }}"
          env:
            - name: OPENRELIK_SERVER_SETTINGS
              value: /var/config/settings.toml
            - name: REDIS_URL
              value: {{ .Values.redis.url }}
          ports:
            - containerPort: {{ .Values.openrelik.server.port }}
              protocol: TCP
          volumeMounts:
            - name: vol-data
              mountPath: /usr/share/openrelik
            {{- if .Values.global.localData }}
            - name: vol-settings
              mountPath: /var/config/settings.toml
              subPath: settings.toml
            {{- end }}
            {{- if .Values.filestore.managed }}
            - name: vol-config
              mountPath: /var/config
            {{- end }}
      restartPolicy: Always
      volumes:
        - name: vol-settings
          configMap:
            name: cm-settings
        {{- if .Values.global.localData }}
        - name: vol-data
          persistentVolumeClaim:
            claimName: pvc-local
        {{- end }}
        {{- if .Values.filestore.managed }}
        - name: vol-data
          persistentVolumeClaim:
            claimName: pvc-filestore
        {{- end }}
        {{- if .Values.postgres.managedSecret }}
        - name: vol-openrelik-db-sec
          csi:
            driver: secrets-store-gke.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: sec-openrelik-db
        - name: vol-config
          emptyDir: {}
        {{- end }}
